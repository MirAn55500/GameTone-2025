<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä DatsJingleBang</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #1e1e2e 0%, #11111b 100%);
      color: #cdd6f4;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #89b4fa;
      text-shadow: 0 0 10px rgba(137, 180, 250, 0.5);
    }

    .controls {
      background: rgba(49, 50, 68, 0.8);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .controls input, .controls select, .controls button {
      padding: 8px 15px;
      border: 1px solid #45475a;
      border-radius: 5px;
      background: #181825;
      color: #cdd6f4;
      font-size: 14px;
    }

    .controls input {
      flex: 1;
      min-width: 200px;
    }

    .controls button {
      background: #89b4fa;
      color: #1e1e2e;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .controls button:hover {
      background: #74c7ec;
      transform: translateY(-2px);
    }

    .controls button:disabled {
      background: #45475a;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      background: rgba(49, 50, 68, 0.8);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .status-item {
      display: flex;
      flex-direction: column;
    }

    .status-label {
      font-size: 12px;
      color: #6c7086;
      margin-bottom: 5px;
    }

    .status-value {
      font-size: 18px;
      font-weight: bold;
      color: #a6e3a1;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    #arena {
      display: grid;
      gap: 2px;
      background: #313244;
      padding: 8px;
      border-radius: 10px;
      border: 2px solid #89b4fa;
      width: fit-content;
      margin: 0 auto;
      box-shadow: 0 0 20px rgba(137, 180, 250, 0.3);
    }

    .cell {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 2px rgba(0, 0, 0, 0.8);
      border-radius: 2px;
      transition: all 0.1s;
    }

    .cell:hover {
      transform: scale(1.2);
      z-index: 10;
      position: relative;
    }

    .wall { 
      background: #6c7086; 
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
    }

    .obstacle { 
      background: #f38ba8; 
      box-shadow: 0 0 5px rgba(243, 139, 168, 0.5);
    }

    .bomb { 
      background: #fab387; 
      box-shadow: 0 0 8px rgba(250, 179, 135, 0.8);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .bomber { 
      background: #89b4fa; 
      box-shadow: 0 0 8px rgba(137, 180, 250, 0.8);
    }

    .enemy { 
      background: #ff0000; 
      box-shadow: 0 0 12px rgba(255, 0, 0, 1), inset 0 0 8px rgba(255, 100, 100, 0.8);
      animation: enemyPulse 1s ease-in-out infinite;
      border: 2px solid #ff4444;
    }
    
    @keyframes enemyPulse {
      0%, 100% { 
        box-shadow: 0 0 12px rgba(255, 0, 0, 1), inset 0 0 8px rgba(255, 100, 100, 0.8);
      }
      50% { 
        box-shadow: 0 0 18px rgba(255, 0, 0, 1.2), inset 0 0 12px rgba(255, 150, 150, 1);
      }
    }

    .mob-ghost { 
      background: #cba6f7; 
      box-shadow: 0 0 8px rgba(203, 166, 247, 0.8);
      animation: float 2s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    .mob-patrol { 
      background: #f9e2af; 
      box-shadow: 0 0 8px rgba(249, 226, 175, 0.8);
    }

    .empty { 
      background: #181825; 
    }

    .safe { 
      box-shadow: 0 0 10px #a6e3a1, inset 0 0 10px #a6e3a1;
      animation: glow 1s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 10px #a6e3a1, inset 0 0 10px #a6e3a1; }
      50% { box-shadow: 0 0 15px #a6e3a1, inset 0 0 15px #a6e3a1; }
    }

    .sidebar {
      background: rgba(49, 50, 68, 0.8);
      padding: 20px;
      border-radius: 10px;
      height: fit-content;
    }

    .sidebar h2 {
      color: #89b4fa;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .bomber-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .bomber-item {
      background: rgba(24, 24, 37, 0.5);
      padding: 10px;
      border-radius: 5px;
      border-left: 3px solid #89b4fa;
    }

    .bomber-item.dead {
      opacity: 0.5;
      border-left-color: #f38ba8;
    }

    .bomber-info {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .bomber-name {
      font-weight: bold;
      color: #89b4fa;
    }

    .bomber-stats {
      color: #6c7086;
      font-size: 11px;
    }

    .error {
      background: rgba(243, 139, 168, 0.2);
      border: 1px solid #f38ba8;
      color: #f38ba8;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .legend {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #45475a;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 2px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #6c7086;
    }

    .zoom-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .zoom-controls button {
      width: 35px;
      height: 35px;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÆ –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä DatsJingleBang</h1>

    <div class="controls">
      <input type="text" id="apiKey" placeholder="API –∫–ª—é—á (–Ω–µ –Ω—É–∂–µ–Ω –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)" />
      <input type="text" id="baseUrl" placeholder="URL —Å–µ—Ä–≤–µ—Ä–∞" value="http://localhost:5000" />
      <label style="display: flex; align-items: center; gap: 5px;">
        <input type="checkbox" id="useLocalServer" checked />
        <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä</span>
      </label>
      <select id="updateInterval">
        <option value="1000" selected>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ~1/—Å–µ–∫ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)</option>
        <option value="1500">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ~0.67/—Å–µ–∫ (–æ—á–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ)</option>
        <option value="2000">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ~0.5/—Å–µ–∫ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ)</option>
      </select>
      <button id="startBtn" onclick="startVisualization()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="stopBtn" onclick="stopVisualization()" disabled>‚è∏ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <div class="zoom-controls">
        <button onclick="zoomOut()">‚àí</button>
        <button onclick="zoomIn()">+</button>
        <button onclick="resetZoom()">‚åÇ</button>
      </div>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div class="status" id="status">
      <div class="status-item">
        <div class="status-label">–ò–≥—Ä–æ–∫</div>
        <div class="status-value" id="playerName">‚Äî</div>
      </div>
      <div class="status-item">
        <div class="status-label">–°—á—ë—Ç</div>
        <div class="status-value" id="score">0</div>
      </div>
      <div class="status-item">
        <div class="status-label">–†–∞—É–Ω–¥</div>
        <div class="status-value" id="round">‚Äî</div>
      </div>
      <div class="status-item">
        <div class="status-label">–ñ–∏–≤—ã—Ö —é–Ω–∏—Ç–æ–≤</div>
        <div class="status-value" id="aliveCount">0</div>
      </div>
      <div class="status-item">
        <div class="status-label">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π</div>
        <div class="status-value" id="obstaclesCount">0</div>
      </div>
      <div class="status-item">
        <div class="status-label">–ë–æ–º–±</div>
        <div class="status-value" id="bombsCount">0</div>
      </div>
    </div>

    <div class="stats-container" style="background: rgba(49, 50, 68, 0.8); padding: 15px; border-radius: 10px; margin-bottom: 20px; overflow-x: auto;">
      <h2 style="color: #89b4fa; margin-bottom: 15px; font-size: 18px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—É–Ω–¥–∞</h2>
      <table id="statsTable" style="width: 100%; border-collapse: collapse; font-size: 12px;">
        <thead>
          <tr style="background: rgba(137, 180, 250, 0.2);">
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–°—á—ë—Ç</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–π –ø—É—Ç—å</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–û—á–∫–∏ –∑–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –±–æ–º–±</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ (–¥—Ä—É–∂/–≤—Ä–∞–≥/–º–æ–±)</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π –∑–∞ –≤–∑—Ä—ã–≤ (1/2/3/4)</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ (–¥—Ä—É–∂/–≤—Ä–∞–≥/–º–æ–±)</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–π</th>
            <th style="padding: 8px; text-align: left; border: 1px solid #45475a;">–®—Ç—Ä–∞—Ñ –∑–∞ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding: 8px; border: 1px solid #45475a; color: #fab387;">0</td>
            <td style="padding: 8px; border: 1px solid #45475a;">0</td>
            <td style="padding: 8px; border: 1px solid #45475a;">‚Äî</td>
            <td style="padding: 8px; border: 1px solid #45475a;">0</td>
            <td style="padding: 8px; border: 1px solid #45475a;">‚Äî</td>
            <td style="padding: 8px; border: 1px solid #45475a;">‚Äî</td>
            <td style="padding: 8px; border: 1px solid #45475a;">‚Äî</td>
            <td style="padding: 8px; border: 1px solid #45475a;">0</td>
            <td style="padding: 8px; border: 1px solid #45475a;">0</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="main-content">
      <div>
        <div id="mapInfo" style="text-align: center; margin-bottom: 10px; color: #6c7086; font-size: 12px;"></div>
        <div id="arena" style="display: none;"></div>
        <div id="loading" class="loading">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å" –¥–ª—è –Ω–∞—á–∞–ª–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏</div>
      </div>

      <div class="sidebar">
        <h2>–Æ–Ω–∏—Ç—ã</h2>
        <div class="bomber-list" id="bomberList">
          <div class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        </div>

        <div class="legend">
          <h2>–õ–µ–≥–µ–Ω–¥–∞</h2>
          <div class="legend-item">
            <div class="legend-color wall"></div>
            <span>–°—Ç–µ–Ω–∞ (–Ω–µ–ø—Ä–æ—Ö–æ–¥–∏–º–∞—è)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color obstacle"></div>
            <span>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ (—Ä–∞–∑—Ä—É—à–∞–µ–º–æ–µ)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color bomb"></div>
            <span>–ë–æ–º–±–∞</span>
          </div>
          <div class="legend-item">
            <div class="legend-color bomber"></div>
            <span>–í–∞—à —é–Ω–∏—Ç</span>
          </div>
          <div class="legend-item">
            <div class="legend-color enemy"></div>
            <span>–í—Ä–∞–≥</span>
          </div>
          <div class="legend-item">
            <div class="legend-color mob-ghost"></div>
            <span>–ü—Ä–∏–∑—Ä–∞–∫</span>
          </div>
          <div class="legend-item">
            <div class="legend-color mob-patrol"></div>
            <span>–ü–∞—Ç—Ä—É–ª—å–Ω—ã–π</span>
          </div>
          <div class="legend-item">
            <div class="legend-color safe"></div>
            <span>–ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let mapSize = [30, 30];
    let grid = [];
    let updateInterval = null;
    let cellSize = 20;
    let apiKey = '';
    let baseUrl = '';
    
    // Rate limiting
    let lastRequestTime = 0;
    let requestTimes = [];
    let consecutive429Errors = 0;
    let currentInterval = 1000; // –ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª 1000–º—Å (1 –∑–∞–ø—Ä–æ—Å/—Å–µ–∫) - –±–µ–∑–æ–ø–∞—Å–Ω–æ

    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å API –∫–ª—é—á –∏–∑ localStorage
    const savedApiKey = localStorage.getItem('apiKey');
    const savedBaseUrl = localStorage.getItem('baseUrl');
    if (savedApiKey) {
      document.getElementById('apiKey').value = savedApiKey;
    }
    if (savedBaseUrl) {
      document.getElementById('baseUrl').value = savedBaseUrl;
    }

    function resetGrid() {
      const [w, h] = mapSize;
      grid = Array(h).fill().map(() => Array(w).fill(null));
    }

    function place(x, y, obj) {
      if (x >= 0 && y >= 0 && y < grid.length && x < grid[0]?.length) {
        grid[y][x] = obj;
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    function rateLimit() {
      const now = Date.now();
      // –£–¥–∞–ª—è–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ä—à–µ 1 —Å–µ–∫—É–Ω–¥—ã
      requestTimes = requestTimes.filter(t => now - t < 1000);
      
      // –ú–∞–∫—Å–∏–º—É–º 1 –∑–∞–ø—Ä–æ—Å –≤ —Å–µ–∫—É–Ω–¥—É –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      if (requestTimes.length >= 1) {
        const waitTime = 1000 - (now - requestTimes[0]);
        if (waitTime > 0) {
          return waitTime;
        }
      }
      
      requestTimes.push(now);
      return 0;
    }

    async function fetchArena() {
      const useLocal = document.getElementById('useLocalServer').checked;
      
      if (!useLocal && !apiKey) {
        showError('API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω');
        return;
      }

      // Rate limiting —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      if (!useLocal) {
        const waitTime = rateLimit();
        if (waitTime > 0) {
          await new Promise(resolve => setTimeout(resolve, waitTime));
        }
      }

      try {
        const url = `${baseUrl}/api/arena`;
        const headers = useLocal ? {} : { 'X-Auth-Token': apiKey };
        const res = await fetch(url, { headers });

        if (!res.ok) {
          if (res.status === 401 || res.status === 403) {
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á');
          }
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ 429
          if (res.status === 429) {
            consecutive429Errors++;
            const backoffTime = Math.min(consecutive429Errors * 500, 5000); // –î–æ 5 —Å–µ–∫—É–Ω–¥
            
            showError(`–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (429). –û–∂–∏–¥–∞–Ω–∏–µ ${backoffTime/1000}—Å...`);
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            if (updateInterval) {
              clearInterval(updateInterval);
              currentInterval = Math.min(currentInterval * 1.5, 5000);
              updateInterval = setInterval(fetchArena, currentInterval);
              
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç
              document.getElementById('updateInterval').value = currentInterval;
            }
            
            // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
            await new Promise(resolve => setTimeout(resolve, backoffTime));
            return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å
          }
          
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        // –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        if (consecutive429Errors > 0) {
          consecutive429Errors = 0;
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
          const selectedInterval = parseInt(document.getElementById('updateInterval').value);
          if (currentInterval !== selectedInterval && updateInterval) {
            clearInterval(updateInterval);
            currentInterval = selectedInterval;
            updateInterval = setInterval(fetchArena, currentInterval);
          }
        }

        const data = await res.json();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã
        if (data.map_size) {
          mapSize = data.map_size;
        }
        resetGrid();

        // –°—Ç–µ–Ω—ã
        if (data.arena?.walls) {
          data.arena.walls.forEach(([x, y]) => place(x, y, { type: 'wall' }));
        }

        // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        if (data.arena?.obstacles) {
          data.arena.obstacles.forEach(([x, y]) => place(x, y, { type: 'obstacle' }));
        }

        // –ë–æ–º–±—ã
        if (data.arena?.bombs) {
          data.arena.bombs.forEach(bomb => {
            place(bomb.pos[0], bomb.pos[1], {
              type: 'bomb',
              timer: bomb.timer,
              range: bomb.range
            });
          });
        }

        // –ú–æ–∏ —é–Ω–∏—Ç—ã (–≤—Å–µ 6, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –≤–∏–¥–Ω—ã)
        if (data.bombers) {
          data.bombers.forEach((b, index) => {
            // –†–∞–∑–º–µ—â–∞–µ–º –≤—Å–µ—Ö –±–æ–º–±–µ—Ä–æ–≤, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –≤ –∑–æ–Ω–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏
            place(b.pos[0], b.pos[1], {
              type: 'bomber',
              safe: b.safe_time > 0,
              id: b.id,
              index: index + 1, // –ù–æ–º–µ—Ä –±–æ–º–±–µ—Ä–∞ (1-6)
              bombs: b.bombs_available,
              armor: b.armor,
              alive: b.alive
            });
          });
        }

        // –í—Ä–∞–≥–∏
        if (data.enemies) {
          data.enemies.forEach(e => {
            place(e.pos[0], e.pos[1], {
              type: 'enemy',
              safe: e.safe_time > 0
            });
          });
        }

        // –ú–æ–±—ã
        if (data.mobs) {
          data.mobs.forEach(m => {
            place(m.pos[0], m.pos[1], {
              type: m.type === 'ghost' ? 'mob-ghost' : 'mob-patrol',
              safe: m.safe_time > 0
            });
          });
        }

        render();
        updateInfo(data);
        updateBomberList(data.bombers || []);
      } catch (err) {
        if (err.message.includes('429')) {
          // –û—à–∏–±–∫–∞ 429 —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤—ã—à–µ
          return;
        }
        showError(`–û—à–∏–±–∫–∞: ${err.message}`);
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', err);
      }
    }

    function render() {
      const arenaEl = document.getElementById('arena');
      const [w, h] = mapSize;
      
      if (!w || !h || w === 0 || h === 0) {
        console.warn('–ù–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã:', mapSize);
        return;
      }
      
      // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –∂–∏–≤—ã—Ö –±–æ–º–±–µ—Ä–æ–≤ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
      const bombers = [];
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const cell = grid[y]?.[x];
          if (cell && cell.type === 'bomber' && cell.alive !== false) {
            bombers.push({x, y, id: cell.id, index: cell.index});
          }
        }
      }
      
      // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –≤—Å–µ—Ö –±–æ–º–±–µ—Ä–æ–≤
      let centerX = w / 2;
      let centerY = h / 2;
      if (bombers.length > 0) {
        centerX = bombers.reduce((sum, b) => sum + b.x, 0) / bombers.length;
        centerY = bombers.reduce((sum, b) => sum + b.y, 0) / bombers.length;
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –±–æ–º–±–µ—Ä–æ–≤, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –∫–∞—Ä—Ç—ã
        centerX = w / 2;
        centerY = h / 2;
      }
      
      // –†–∞–∑–º–µ—Ä –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ (–æ–∫–Ω–æ –≤–æ–∫—Ä—É–≥ –±–æ–º–±–µ—Ä–æ–≤)
      const viewRadius = 20; // –†–∞–¥–∏—É—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏ (—É–≤–µ–ª–∏—á–µ–Ω –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–±–∑–æ—Ä–∞)
      const minX = Math.max(0, Math.floor(centerX - viewRadius));
      const maxX = Math.min(w, Math.ceil(centerX + viewRadius));
      const minY = Math.max(0, Math.floor(centerY - viewRadius));
      const maxY = Math.min(h, Math.ceil(centerY + viewRadius));
      
      const viewWidth = maxX - minX;
      const viewHeight = maxY - minY;
      
      arenaEl.style.gridTemplateColumns = `repeat(${viewWidth}, ${cellSize}px)`;
      arenaEl.style.display = 'grid';
      document.getElementById('loading').style.display = 'none';

      let html = '';

      for (let y = minY; y < maxY; y++) {
        for (let x = minX; x < maxX; x++) {
          const cell = grid[y]?.[x] || { type: 'empty' };
          const cls = cell.type + (cell.safe ? ' safe' : '');
          let content = '';
          
          if (cell.type === 'bomb') {
            content = Math.ceil(cell.timer);
          } else if (cell.type === 'bomber') {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä –±–æ–º–±–µ—Ä–∞ (1-6) –∏–∑ –¥–∞–Ω–Ω—ã—Ö
            content = cell.index || 'B';
          } else if (cell.type === 'enemy') {
            content = '‚öî'; // –ë–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–π —Å–∏–º–≤–æ–ª –¥–ª—è –≤—Ä–∞–≥–∞
          } else if (cell.type === 'mob-ghost') {
            content = 'üëª';
          } else if (cell.type === 'mob-patrol') {
            content = 'üëÆ';
          }
          
          html += `<div class="cell ${cls}" title="X:${x} Y:${y}">${content}</div>`;
        }
      }
      
      arenaEl.innerHTML = html;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–∏
      const info = document.getElementById('mapInfo');
      if (info) {
        const bomberInfo = bombers.map(b => `#${b.index || '?'} [${b.x},${b.y}]`).join(' ');
        info.textContent = `–¶–µ–Ω—Ç—Ä: [${Math.floor(centerX)}, ${Math.floor(centerY)}] | –í–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å: ${viewWidth}x${viewHeight} | –ë–æ–º–±–µ—Ä–æ–≤: ${bombers.length}/6 ${bomberInfo ? '| ' + bomberInfo : ''}`;
      }
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    let stats = {
      score: 0,
      distance: 0,
      obstaclesDestroyed: 0,
      pointsFromObstacles: 0,
      pointsFromKills: 0,
      pointsFromMobKills: 0,
      bombsPlaced: 0,
      bomberKillsEnemy: 0,
      bomberKillsFriendly: 0,
      bomberKillsSystem: 0,
      obstaclesPerBomb: {0: 0, 1: 0, 2: 0, 3: 0, 4: 0},
      multiKillEnemy: 0,
      multiKillFriendly: 0,
      multiKillSystem: 0,
      respawns: 0,
      pointsLostToRespawn: 0
    };

    function updateInfo(data) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      document.getElementById('playerName').textContent = data.player || '‚Äî';
      stats.score = data.raw_score || 0;
      document.getElementById('score').textContent = stats.score;
      document.getElementById('round').textContent = data.round || '‚Äî';
      
      const alive = (data.bombers || []).filter(b => b.alive).length;
      document.getElementById('aliveCount').textContent = `${alive}/${data.bombers?.length || 0}`;
      document.getElementById('obstaclesCount').textContent = (data.arena?.obstacles || []).length;
      document.getElementById('bombsCount').textContent = (data.arena?.bombs || []).length;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
      if (data.stats) {
        stats.distance = data.stats.distance || 0;
        stats.obstaclesDestroyed = data.stats.obstaclesDestroyed || 0;
        stats.pointsFromObstacles = data.stats.pointsFromObstacles || 0;
        stats.pointsFromKills = data.stats.pointsFromKills || 0;
        stats.pointsFromMobKills = data.stats.pointsFromMobKills || 0;
        stats.bombsPlaced = data.stats.bombsPlaced || 0;
        stats.bomberKillsEnemy = data.stats.bomberKillsEnemy || 0;
        stats.bomberKillsFriendly = data.stats.bomberKillsFriendly || 0;
        stats.bomberKillsSystem = data.stats.bomberKillsSystem || 0;
        stats.respawns = data.stats.respawns || 0;
        stats.pointsLostToRespawn = data.stats.pointsLostToRespawn || 0;
        stats.multiKillEnemy = data.stats.multiKillEnemy || 0;
        stats.multiKillFriendly = data.stats.multiKillFriendly || 0;
        stats.multiKillSystem = data.stats.multiKillSystem || 0;
        
        if (data.stats.bombsDestroyedObstacles_0 !== undefined) {
          stats.obstaclesPerBomb[0] = data.stats.bombsDestroyedObstacles_0 || 0;
          stats.obstaclesPerBomb[1] = data.stats.bombsDestroyedObstacles_1 || 0;
          stats.obstaclesPerBomb[2] = data.stats.bombsDestroyedObstacles_2 || 0;
          stats.obstaclesPerBomb[3] = data.stats.bombsDestroyedObstacles_3 || 0;
          stats.obstaclesPerBomb[4] = data.stats.bombsDestroyedObstacles_4 || 0;
        }
      }
      
      updateStatsTable();
    }
    
    function updateStatsTable() {
      const statsTable = document.getElementById('statsTable');
      if (!statsTable) return;
      
      const tbody = statsTable.querySelector('tbody');
      if (!tbody) return;
      
      const pointsTotal = stats.pointsFromObstacles + stats.pointsFromKills + stats.pointsFromMobKills;
      const obstaclesPerBombStr = [
        stats.obstaclesPerBomb[1] || 0,
        stats.obstaclesPerBomb[2] || 0,
        stats.obstaclesPerBomb[3] || 0,
        stats.obstaclesPerBomb[4] || 0
      ].join(' / ');
      
      tbody.innerHTML = `
        <tr>
          <td style="padding: 8px; border: 1px solid #45475a; color: #fab387;">${stats.score || 0}</td>
          <td style="padding: 8px; border: 1px solid #45475a;">${stats.distance || 0}</td>
          <td style="padding: 8px; border: 1px solid #45475a;">${pointsTotal || '‚Äî'}</td>
          <td style="padding: 8px; border: 1px solid #45475a;">${stats.bombsPlaced || 0}</td>
          <td style="padding: 8px; border: 1px solid #45475a;">${stats.bomberKillsFriendly || 0} / ${stats.bomberKillsEnemy || 0} / ${stats.bomberKillsSystem || 0}</td>
          <td style="padding: 8px; border: 1px solid #45475a;">${obstaclesPerBombStr || '‚Äî'}</td>
          <td style="padding: 8px; border: 1px solid #45475a;">${stats.multiKillFriendly || 0} / ${stats.multiKillEnemy || 0} / ${stats.multiKillSystem || 0}</td>
          <td style="padding: 8px; border: 1px solid #45475a;">${stats.respawns || 0}</td>
          <td style="padding: 8px; border: 1px solid #45475a;">${stats.pointsLostToRespawn || 0}</td>
        </tr>
      `;
    }

    function updateBomberList(bombers) {
      const listEl = document.getElementById('bomberList');
      
      if (!bombers || bombers.length === 0) {
        listEl.innerHTML = '<div class="loading">–ù–µ—Ç —é–Ω–∏—Ç–æ–≤</div>';
        return;
      }

      listEl.innerHTML = bombers.map(b => {
        const status = b.alive ? '–ñ–∏–≤' : '–ú—ë—Ä—Ç–≤';
        const canMove = b.can_move ? '–ú–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è' : '–î–≤–∏–∂–µ—Ç—Å—è...';
        return `
          <div class="bomber-item ${b.alive ? '' : 'dead'}">
            <div class="bomber-info">
              <div class="bomber-name">${b.id.substring(0, 12)}...</div>
              <div class="bomber-stats">
                –ü–æ–∑–∏—Ü–∏—è: [${b.pos[0]}, ${b.pos[1]}]<br>
                –°—Ç–∞—Ç—É—Å: ${status}<br>
                ${canMove}<br>
                –ë–æ–º–±: ${b.bombs_available} | –ë—Ä–æ–Ω—è: ${b.armor || 0}
                ${b.safe_time > 0 ? ` | –ù–µ—É—è–∑–≤–∏–º: ${(b.safe_time / 1000).toFixed(1)}—Å` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function startVisualization() {
      const useLocal = document.getElementById('useLocalServer').checked;
      apiKey = document.getElementById('apiKey').value.trim();
      baseUrl = document.getElementById('baseUrl').value.trim();

      if (!useLocal && !apiKey) {
        showError('–£–∫–∞–∂–∏—Ç–µ API –∫–ª—é—á –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä');
        return;
      }

      if (!baseUrl) {
        showError('–£–∫–∞–∂–∏—Ç–µ URL —Å–µ—Ä–≤–µ—Ä–∞');
        return;
      }
      
      if (useLocal) {
        console.log('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞');
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
      localStorage.setItem('apiKey', apiKey);
      localStorage.setItem('baseUrl', baseUrl);

      const interval = parseInt(document.getElementById('updateInterval').value);
      currentInterval = interval;
      consecutive429Errors = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
      
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;

      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å—Ä–∞–∑—É
      fetchArena();

      // –ó–∞—Ç–µ–º –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É
      updateInterval = setInterval(fetchArena, interval);
    }

    function stopVisualization() {
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }

    function zoomIn() {
      cellSize = Math.min(cellSize + 2, 40);
      if (updateInterval) {
        render();
      }
    }

    function zoomOut() {
      cellSize = Math.max(cellSize - 2, 12);
      if (updateInterval) {
        render();
      }
    }

    function resetZoom() {
      cellSize = 20;
      if (updateInterval) {
        render();
      }
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', stopVisualization);
  </script>
</body>
</html>

